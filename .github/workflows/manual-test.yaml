name: Manual Test

on: 
  workflow_dispatch:

jobs:
  generate-data:
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.os }} (${{ matrix.config.r }})
  
    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: ubuntu-20.04, r: 'release', rspm: "https://packagemanager.rstudio.com/cran/__linux__/focal/latest"}

    env:
        RSPM: ${{ matrix.config.rspm }}
        R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
        GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
  
    steps:
        - uses: actions/checkout@v3

        - uses: r-lib/actions/setup-r@v2
        - name: Query dependencies
          run: |
            install.packages('remotes')
            saveRDS(remotes::dev_package_deps(dependencies = TRUE), ".github/depends.Rds", version = 2)
            writeLines(sprintf("R-%i.%i", getRversion()$major, getRversion()$minor), ".github/R-version")
          shell: Rscript {0}


        - name: Cache R packages
          uses: actions/cache@v1
          with:
            path: ${{ env.R_LIBS_USER }}
            key: ${{ runner.os }}-${{ hashFiles('.github/R-version') }}-1-${{ hashFiles('.github/depends.Rds') }}
            restore-keys: ${{ runner.os }}-${{ hashFiles('.github/R-version') }}-1-

        - name: Install dependencies
          run: |
            remotes::install_deps(dependencies = TRUE)
            install.packages("XML")
            install.packages("devtools")
            devtools::install_github("PecanProject/rpecanapi")
            install.packages("dplyr")
            install.packages("tidyr")
            install.packages("curl")
          shell: Rscript {0}
          
        - name: Generate data
          run: |
            source("inst/run-test-list.R")
          shell: Rscript {0}
      
        
        - name: Session info
          run: |
            options(width = 100)
            pkgs <- installed.packages()[, "Package"]
            sessioninfo::session_info(pkgs, include_base = TRUE)
          shell: Rscript {0}
          
        - name: Push to github
          run: |
              git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com" && \
                git config --global user.name "${GITHUB_ACTOR}"
              git add --all *
              git commit -m "Update Result"
              git push -q origin main
